//@version=5
indicator("BMNR Power Law", overlay=true, shorttitle="BMNR Adv Signal")

// ==========================================
// --- 1. æ•°æ®æºä¸ŽåŸºç¡€æ¨¡åž‹å‚æ•° ---
// ==========================================
grp_data = "æ•°æ®æºè®¾ç½®"
eth_ticker = input.symbol("COINBASE:ETHUSD", "ETH äº¤æ˜“å¯¹ä»£ç ", group=grp_data)

grp_model = "åŸºç¡€å¹‚å¾‹å‚æ•° (Power Law)"
mid_scale = input.float(0.00057, "ä¸­è½¨ Scale (A)", group=grp_model)
mid_exp   = input.float(1.3625, "ä¸­è½¨ Exponent (B)", group=grp_model)

top_scale = input.float(0.00097, "ä¸Šè½¨ Scale (A)", group=grp_model)
top_exp   = input.float(1.3144, "ä¸Šè½¨ Exponent (B)", group=grp_model)

bot_scale = input.float(0.00148, "ä¸‹è½¨ Scale (A)", group=grp_model)
bot_exp   = input.float(1.2291, "ä¸‹è½¨ Exponent (B)", group=grp_model)

// ==========================================
// --- 2. è¿›é˜¶æ³¢åŠ¨çŽ‡ä¿®æ­£ (ATR) ---
// ==========================================
grp_adv = "æ³¢åŠ¨çŽ‡åŠ¨æ€ä¿®æ­£ (è¿‡æ»¤å‡çªç ´)"
use_atr_adj = input.bool(true, "å¼€å¯ ATR å¼¹æ€§è½¨é“ï¼Ÿ", group=grp_adv)
atr_period  = input.int(14, "ATR å‘¨æœŸ", minval=1, group=grp_adv)
atr_mult    = input.float(1.0, "ATR ä¿®æ­£ç³»æ•°", step=0.1, group=grp_adv)

// ==========================================
// --- 3. æ˜¾ç¤ºè®¾ç½® ---
// ==========================================
grp_disp = "æ˜¾ç¤ºè®¾ç½®"
use_filter = input.bool(true, "ä»…åœ¨ç‰¹å®šæ—¶é—´å†…æ˜¾ç¤ºä¿¡å·ï¼Ÿ", group=grp_disp)
start_time = input.time(timestamp("2024-01-01 00:00:00"), "æ˜¾ç¤ºå¼€å§‹æ—¶é—´", group=grp_disp)
end_time   = input.time(timestamp("2026-12-31 23:59:59"), "æ˜¾ç¤ºç»“æŸæ—¶é—´", group=grp_disp)

show_signal = not use_filter or (time >= start_time and time <= end_time)

// ==========================================
// --- 4. æ ¸å¿ƒè®¡ç®—é€»è¾‘ ---
// ==========================================
// èŽ·å– ETH æ—¥çº¿å…³é—­ä»·æ ¼
eth_price_d = request.security(eth_ticker, "D", close, gaps=barmerge.gaps_off)

// è®¡ç®—åŸºç¡€å¹‚å¾‹è½¨é“
base_top = top_scale * math.pow(eth_price_d, top_exp)
base_mid = mid_scale * math.pow(eth_price_d, mid_exp)
base_bot = bot_scale * math.pow(eth_price_d, bot_exp)

// è®¡ç®— ATR ä¿®æ­£å€¼
atr_val = ta.atr(atr_period)
adj_val = use_atr_adj ? atr_val * atr_mult : 0

// æœ€ç»ˆåŠ¨æ€è½¨é“
val_top = base_top + adj_val
val_mid = base_mid
val_bot = base_bot - adj_val

// ==========================================
// --- 5. ç»˜å›¾ä¸Žè§†è§‰åé¦ˆ ---
// ==========================================
plot_top = plot(val_top, "åŠ¨æ€åŽ‹åŠ›ä½ (çº¢)", color=color.new(color.red, 0), linewidth=2)
plot_mid = plot(val_mid, "ä»·å€¼ä¸­æž¢ (è“)", color=color.new(color.blue, 50), linewidth=1, style=plot.style_linebr)
plot_bot = plot(val_bot, "åŠ¨æ€æ”¯æ’‘ä½ (ç»¿)", color=color.new(color.green, 0), linewidth=2)

// å¡«å……åŒºé—´
fill(plot_top, plot_bot, color=color.new(color.gray, 95), title="ä¼°å€¼åˆç†åŒº")

// ä¿¡å·åˆ¤å®š
is_buy  = ta.crossunder(close, val_bot) and show_signal
is_sell = ta.crossover(close, val_top) and show_signal

// ç»˜åˆ¶å›¾æ ‡
plotshape(is_buy,  title="æŠ„åº•", style=shape.arrowup,   location=location.belowbar, color=color.green, size=size.normal, text="BUY")
plotshape(is_sell, title="é€ƒé¡¶", style=shape.arrowdown, location=location.abovebar, color=color.red,   size=size.normal, text="SELL")

// æžç«¯è¡Œæƒ…èƒŒæ™¯é«˜äº®
bgcolor(show_signal and close <= val_bot ? color.new(color.green, 90) : na)
bgcolor(show_signal and close >= val_top ? color.new(color.red, 90) : na)

// ==========================================
// --- 6. å®žæ—¶çŠ¶æ€é¢æ¿ (Dashboard) ---
// ==========================================
var table panel = table.new(position.top_right, 2, 4, border_width=1, border_color=color.gray)
if barstate.islast
    premium = (close - val_mid) / val_mid * 100
    status_color = close >= val_top ? color.red : (close <= val_bot ? color.green : color.gray)
    
    table.cell(panel, 0, 0, "åŸºå‡† ETH", bgcolor=color.gray, text_color=color.white)
    table.cell(panel, 1, 0, str.tostring(eth_price_d, "#.##"), bgcolor=color.black, text_color=color.white)
    
    table.cell(panel, 0, 1, "åç¦»åº¦", bgcolor=color.gray, text_color=color.white)
    table.cell(panel, 1, 1, str.tostring(premium, "#.1") + "%", bgcolor=status_color, text_color=color.white)

    table.cell(panel, 0, 2, "è½¨é“å®½åº¦ (ATR)", bgcolor=color.gray, text_color=color.white)
    table.cell(panel, 1, 2, str.tostring(adj_val, "#.##"), bgcolor=color.black, text_color=color.white)

    table.cell(panel, 0, 3, "å½“å‰ä»·æ ¼", bgcolor=color.gray, text_color=color.white)
    table.cell(panel, 1, 3, str.tostring(close, "#.##"), bgcolor=color.black, text_color=color.white)

// ==========================================
// --- 7. é¢„è®¾è­¦æŠ¥é€»è¾‘ (ç”¨äºŽ Telegram æŽ¨é€) ---
// ==========================================

// æž„é€ æŽ¨é€æ–‡æœ¬
string buy_msg = "ðŸŸ¢ **BMNR æŠ„åº•é¢„è­¦**\n" + 
                 "------------------\n" +
                 "å½“å‰ä»·æ ¼: " + str.tostring(close, "#.####") + "\n" +
                 "æ”¯æ’‘ä½(ä¸‹è½¨): " + str.tostring(val_bot, "#.####") + "\n" +
                 "ETHå‚è€ƒä»·: " + str.tostring(eth_price_d, "#.##") + "\n" +
                 "åç¦»åº¦: " + str.tostring((close - val_mid) / val_mid * 100, "#.1") + "%"

string sell_msg = "ðŸ”´ **BMNR é€ƒé¡¶é¢„è­¦**\n" + 
                  "------------------\n" +
                  "å½“å‰ä»·æ ¼: " + str.tostring(close, "#.####") + "\n" +
                  "åŽ‹åŠ›ä½(ä¸Šè½¨): " + str.tostring(val_top, "#.####") + "\n" +
                  "ETHå‚è€ƒä»·: " + str.tostring(eth_price_d, "#.##") + "\n" +
                  "åç¦»åº¦: " + str.tostring((close - val_mid) / val_mid * 100, "#.1") + "%"

// è§¦å‘é€»è¾‘
if is_buy
    alert(buy_msg, alert.freq_once_per_bar_close) // æ¯æ¬¡æ”¶ç›˜ç¡®è®¤ç ´ä½æ‰å‘ï¼Œå‡å°‘è¯¯æŠ¥

if is_sell
    alert(sell_msg, alert.freq_once_per_bar_close)
